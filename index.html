<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Defient Flag Football Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
    }
    canvas {
      background-color: #228B22;
      display: block;
      border: 2px solid #333;
    }
    #ui {
      position: absolute;
      top: 10px;
      text-align: center;
      width: 100%;
      color: white;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #message {
      font-size: 24px;
      font-weight: bold;
      color: white;
      height: 30px;
    }
    #summary {
      font-size: 20px;
      font-weight: bold;
      color: black;
    }
    #joystick {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid #fff;
      touch-action: none;
      display: none;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div id="summary"></div>
    <div>Level: <span id="level">1</span> | Defient Tokens: <span id="tokens">0</span></div>
    <button id="startButton">Start</button>
    <button id="retryButton" style="display:none">Retry</button>
    <button id="playAgainButton" style="display:none">Play Level 1</button>
    <div id="message"></div>
  </div>

  <canvas id="gameCanvas"></canvas>
  <div id="joystick"></div>

  <audio id="whistle" src="https://www.soundjay.com/button/beep-07.wav"></audio>
  <audio id="cheer" src="https://www.soundjay.com/human/cheering-01.wav"></audio>
  <audio id="flagPull" src="https://www.soundjay.com/button/button-3.wav"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startButton = document.getElementById("startButton");
    const retryButton = document.getElementById("retryButton");
    const playAgainButton = document.getElementById("playAgainButton");
    const levelText = document.getElementById("level");
    const tokensText = document.getElementById("tokens");
    const message = document.getElementById("message");
    const summary = document.getElementById("summary");
    const whistle = document.getElementById("whistle");
    const cheer = document.getElementById("cheer");
    const flagPull = document.getElementById("flagPull");
    const joystick = document.getElementById("joystick");

    let gameState = "start";
    let player = { x: 50, y: 100, w: 20, h: 20, speed: 2 };
    let ball = { x: 750, y: 250, active: false };
    let defenders = [];
    let level = 1;
    let tokens = 0;
    let keys = {};
    let countdown = 0;
    let caughtBall = false;

    function resizeCanvas() {
      if (window.innerWidth > window.innerHeight) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        joystick.style.right = "20px";
        joystick.style.bottom = "20px";
      } else {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        joystick.style.left = `${(window.innerWidth - 120) / 2}px`;
        joystick.style.bottom = "20px";
      }
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function resetGame() {
      player = { x: 50, y: canvas.height / 2 - 10, w: 20, h: 20, speed: 2 };
      ball = { x: canvas.width - 50, y: canvas.height / 2, active: true };
      caughtBall = false;
      defenders = [
        { x: canvas.width / 2, y: 150, w: 20, h: 20, speed: 1 + level * 0.3 },
        { x: canvas.width / 2, y: 250, w: 20, h: 20, speed: 1 + level * 0.3 },
        { x: canvas.width / 2, y: 350, w: 20, h: 20, speed: 1 + level * 0.3 },
        { x: canvas.width / 2 + 100, y: canvas.height / 2, w: 20, h: 20, speed: 1 + level * 0.3 }
      ];
    }

    function drawPlayer() {
      ctx.fillStyle = "#ffff00";
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.fillStyle = "blue";
      ctx.fillRect(player.x + player.w, player.y + player.h / 4, 6, 8);
    }

    function drawBall() {
      if (ball.active && !caughtBall) {
        ctx.fillStyle = "brown";
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, 5, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawDefenders() {
      ctx.fillStyle = "red";
      defenders.forEach(d => ctx.fillRect(d.x, d.y, d.w, d.h));
    }

    function drawTouchdownZone() {
      ctx.fillStyle = "#006400";
      ctx.fillRect(canvas.width - 50, 0, 50, canvas.height);
      ctx.save();
      ctx.fillStyle = "white";
      ctx.font = "bold 20px Arial";
      ctx.translate(canvas.width - 25, canvas.height / 2);
      ctx.rotate(Math.PI / 2);
      ctx.fillText("Defient Sports", -ctx.measureText("Defient Sports").width / 2, 0);
      ctx.restore();
    }

    function moveDefenders() {
      defenders.forEach(d => {
        const dx = player.x - d.x;
        const dy = player.y - d.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const scale = d.speed / dist;
        d.x += dx * scale;
        d.y += dy * scale;
      });
    }

    function checkCollision(r1, r2) {
      return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
    }

    function updateGame() {
      if (countdown > 0) {
        message.innerText = countdown;
        countdown--;
        return;
      } else if (countdown === 0 && ball.active && !caughtBall) {
        message.innerText = "Catch the Ball!";
        ball.x -= 4;
        if (checkCollision(player, { x: ball.x - 5, y: ball.y - 5, w: 10, h: 10 })) {
          caughtBall = true;
          ball.active = false;
          message.innerText = "";
        }
        return;
      }

      if (keys["ArrowUp"]) player.y -= player.speed;
      if (keys["ArrowDown"]) player.y += player.speed;
      if (keys["ArrowLeft"]) player.x -= player.speed;
      if (keys["ArrowRight"]) player.x += player.speed * 1.5;

      if (player.y < 0 || player.y + player.h > canvas.height || player.x < 0 || player.x + player.w > canvas.width) {
        flagPull.play();
        message.innerText = "OUT OF BOUNDS - FLAG GRABBED!";
        summary.innerText = `Final Level: ${level} | Tokens Earned: ${tokens}`;
        gameState = "pulled";
        retryButton.style.display = "inline";
        return;
      }

      if (caughtBall) moveDefenders();

      for (let d of defenders) {
        if (checkCollision(player, d)) {
          flagPull.play();
          message.innerText = "FLAG GRABBED!";
          summary.innerText = `Final Level: ${level} | Tokens Earned: ${tokens}`;
          gameState = "pulled";
          retryButton.style.display = "inline";
          return;
        }
      }

      if (player.x + player.w >= canvas.width - 50) {
        cheer.play();
        gameState = "scored";
        tokens += level;
        level++;
        tokensText.innerText = tokens;
        levelText.innerText = level;
        playAgainButton.innerText = `Play Level ${level}`;
        playAgainButton.style.display = "inline";
      }
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawTouchdownZone();
      drawPlayer();
      drawBall();
      drawDefenders();

      if (gameState === "playing") {
        updateGame();
        requestAnimationFrame(gameLoop);
      }
    }

    startButton.onclick = () => {
      startButton.disabled = true;
      whistle.play();
      countdown = 5;
      message.innerText = "5";
      summary.innerText = "";
      gameState = "playing";
      resetGame();
      gameLoop();
    };

    retryButton.onclick = () => {
      retryButton.style.display = "none";
      message.innerText = "";
      summary.innerText = "";
      playAgainButton.innerText = `Play Level ${level}`;
      playAgainButton.style.display = "inline";
      gameState = "start";
      startButton.disabled = false;
    };

    playAgainButton.onclick = () => {
      playAgainButton.style.display = "none";
      message.innerText = "5";
      summary.innerText = "";
      whistle.play();
      countdown = 5;
      gameState = "playing";
      resetGame();
      gameLoop();
    };

    document.addEventListener("keydown", e => (keys[e.key] = true));
    document.addEventListener("keyup", e => (keys[e.key] = false));

    let joyActive = false;
    let joyStartX = 0;
    let joyStartY = 0;

    joystick.addEventListener("touchstart", e => {
      joyActive = true;
      const touch = e.touches[0];
      joyStartX = touch.clientX;
      joyStartY = touch.clientY;
    });

    joystick.addEventListener("touchmove", e => {
      if (!joyActive) return;
      const touch = e.touches[0];
      const dx = touch.clientX - joyStartX;
      const dy = touch.clientY - joyStartY;
      keys = {};
      if (dy < -10) keys["ArrowUp"] = true;
      if (dy > 10) keys["ArrowDown"] = true;
      if (dx < -10) keys["ArrowLeft"] = true;
      if (dx > 10) keys["ArrowRight"] = true;
    });

    joystick.addEventListener("touchend", () => {
      joyActive = false;
      keys = {};
    });

    // Show joystick on mobile only
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      joystick.style.display = "block";
    }
  </script>
</body>
</html>
