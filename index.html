<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defient Flag Football</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      background-color: #228B22;
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: white;
      z-index: 2;
    }
    button, input {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    .mobile-controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: none;
      flex-direction: column;
      z-index: 3;
    }
    .mobile-controls button {
      margin: 5px;
      padding: 15px;
      font-size: 18px;
    }
    #joystickZone {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 50%;
      z-index: 1;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="ui">
    <input id="username" placeholder="Enter Username">
    <button onclick="startLevel()">Start Game</button>
    <div>
      <label>Tokens to Spend on Speed Burst: </label>
      <input id="tokenInput" type="number" value="0" min="0">
    </div>
    <div id="message"></div>
  </div>

  <div id="joystickZone"></div>
  <div class="mobile-controls" id="mobileControls">
    <button onclick="useJuke()">Juke</button>
    <button onclick="useLateral()">Toss</button>
    <button onclick="useSpeedBurst()">Speed Burst</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const usernameInput = document.getElementById('username');
    const tokenInput = document.getElementById('tokenInput');
    const messageEl = document.getElementById('message');

    const joystickZone = document.getElementById('joystickZone');
    const mobileControls = document.getElementById('mobileControls');
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    if (isMobile) mobileControls.style.display = 'flex';

    let username = '';
    let tokens = 0;
    let level = 1;
    let spentBursts = 0;
    let remainingBursts = 0;
    let players = [];
    let defenders = [];
    let ballCarrier = null;
    let lateralCount = 0;
    let keys = {};
    let direction = {x: 0, y: 0};
    let gameRunning = false;
    let jukeCooldown = false;
    let burstActive = false;
    let burstTimer = 0;

    function startLevel() {
      username = usernameInput.value.trim();
      if (!username) return alert("Enter a username");

      spentBursts = parseInt(tokenInput.value);
      if (spentBursts > tokens) return alert("Not enough tokens");
      remainingBursts = spentBursts;
      tokens -= spentBursts;

      setupField();
      setupPlayers();
      setupDefenders();

      ballCarrier = players[Math.floor(Math.random() * players.length)];
      ballCarrier.hasBall = true;

      gameRunning = true;
      lateralCount = 0;
      direction = {x: 0, y: 0};
      jukeCooldown = false;

      requestAnimationFrame(gameLoop);
    }

    function setupField() {
      ctx.fillStyle = '#228B22';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function setupPlayers() {
      players = [];
      const spacing = canvas.height / 5;
      for (let i = 0; i < 4; i++) {
        players.push({
          x: 100,
          y: spacing * (i + 1),
          hasBall: false
        });
      }
    }

    function setupDefenders() {
      defenders = [];
      for (let i = 0; i < 4; i++) {
        defenders.push({
          x: canvas.width - 200,
          y: (canvas.height / 5) * (i + 1)
        });
      }
    }

    function gameLoop() {
      if (!gameRunning) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw Endzones
      ctx.fillStyle = '#006400';
      ctx.fillRect(0, 0, 50, canvas.height);
      ctx.fillRect(canvas.width - 50, 0, 50, canvas.height);
      ctx.fillStyle = 'white';
      ctx.fillText("Defient Sports Touchdown", 10, canvas.height / 2);
      ctx.fillText("Defient Sports Touchdown", canvas.width - 220, canvas.height / 2);

      // Midfield
      ctx.fillStyle = 'white';
      ctx.fillRect(canvas.width / 2, 0, 2, canvas.height);

      // Draw players
      players.forEach(p => {
        ctx.fillStyle = p.hasBall ? '#ffd700' : '#ffd700';
        ctx.fillRect(p.x, p.y, 30, 30);
        if (p.hasBall) {
          ctx.fillStyle = '#309df6';
          ctx.fillRect(p.x + 30, p.y + 10, 6, 10);
        }
      });

      defenders.forEach(d => {
        ctx.fillStyle = 'red';
        ctx.fillRect(d.x, d.y, 30, 30);
      });

      updateMovement();
      updateDefenders();

      if (burstActive && Date.now() > burstTimer) burstActive = false;

      requestAnimationFrame(gameLoop);
    }

    function updateMovement() {
      const speed = burstActive ? 5 : 3;
      if (!ballCarrier) return;

      ballCarrier.x += direction.x * speed;
      ballCarrier.y += direction.y * speed;
    }

    function updateDefenders() {
      defenders.forEach(d => {
        const dx = ballCarrier.x - d.x;
        const dy = ballCarrier.y - d.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const speed = 2 + level * 0.1;

        if (dist > 0) {
          d.x += (dx / dist) * speed;
          d.y += (dy / dist) * speed;
        }

        if (
          ballCarrier.x < d.x + 30 &&
          ballCarrier.x + 30 > d.x &&
          ballCarrier.y < d.y + 30 &&
          ballCarrier.y + 30 > d.y
        ) {
          if (!jukeCooldown && Math.random() > 0.5) {
            endGame("Flag grabbed");
          }
        }
      });
    }

    function endGame(reason) {
      gameRunning = false;
      messageEl.textContent = `${reason}. Level: ${level}, Tokens: ${tokens}`;
    }

    function useJuke() {
      if (jukeCooldown) return;
      jukeCooldown = true;
      setTimeout(() => jukeCooldown = false, 2000);
    }

    function useSpeedBurst() {
      if (remainingBursts <= 0 || burstActive) return;
      remainingBursts--;
      burstActive = true;
      burstTimer = Date.now() + 1000;
    }

    function useLateral() {
      if (lateralCount >= 2) return;
      const behindPlayers = players.filter(p => !p.hasBall && p.x <= ballCarrier.x);
      if (behindPlayers.length === 0) return;
      const target = behindPlayers[Math.floor(Math.random() * behindPlayers.length)];
      ballCarrier.hasBall = false;
      target.hasBall = true;
      ballCarrier = target;
      lateralCount++;
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') direction.y = -1;
      if (e.key === 'ArrowDown') direction.y = 1;
      if (e.key === 'ArrowLeft') direction.x = -1;
      if (e.key === 'ArrowRight') direction.x = 1;
      if (e.key === ' ') useLateral();
      if (e.key === 'j') useJuke();
      if (e.key === 'k') useSpeedBurst();
    });
    document.addEventListener('keyup', e => {
      if (["ArrowUp", "ArrowDown"]).includes(e.key)) direction.y = 0;
      if (["ArrowLeft", "ArrowRight"]).includes(e.key)) direction.x = 0;
    });
  </script>
</body>
</html>
